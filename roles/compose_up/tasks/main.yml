- name: Create Compose Directories
  ansible.builtin.file:
    path: /home/ansible/{{ item }}/
    state: directory
    owner: root
    group: root
    mode: '775'
  loop: "{{ compose | default([], true) }}"

- name: Create Config Directories
  ansible.builtin.file:
    path: /home/ansible/{{ item }}/config/
    state: directory
    owner: root
    group: root
    mode: '775'
  loop: "{{ compose | default([], true) }}"

- name: Create Tailscale Directories
  ansible.builtin.file:
    path: /home/ansible/{{ item }}/ts/
    state: directory
    owner: root
    group: root
    mode: '775'
  loop: "{{ compose | default([], true) }}"

- name: Copy docker compose files
  ansible.builtin.template:
    src: templates/{{ item }}.yml.j2
    dest: /home/ansible/{{ item }}/docker-compose.yml
    owner: root
    group: root
    mode: '664'
  loop: "{{ compose | default([], true) }}"
  vars:
    tailscale_authkey: "{{ lookup('community.general.bitwarden', 'tailscale_auth_key', field='notes')[0] }}"

- name: Deploy dockers
  community.docker.docker_compose_v2:
    project_src: /home/ansible/{{ item }}/
    files:
      - "docker-compose.yml"
  loop: "{{ compose | default([], true) }}"
